name: Build and Publish

on:
  push:
    branches:
      - main

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    env:
      JAVA_VERSION: 17

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Build with Maven
      run: mvn clean install

    - name: Publish to GitHub Packages
      if: github.event_name == 'push'
      run: mvn deploy
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build Maven Site
      run: mvn site

    - name: Deploy to GitHub Pages
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git clone --branch gh-pages https://github.com/caimito/token-weaver.git gh-pages
        rsync -av --delete target/site/ gh-pages/
        cd gh-pages
        git add .
        git commit -m "Deploy site to GitHub Pages"
        git push origin gh-pages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Increment version
      id: increment_version
      run: |
        current_version=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        base_version=$(echo $current_version | sed -E 's/([0-9]+\.[0-9]+\.[0-9]+)/\1/')
        IFS='.' read -r -a version_parts <<< "$base_version"
        last_part=${version_parts[2]}
        new_last_part=$((last_part + 1))
        new_version="${version_parts[0]}.${version_parts[1]}.$new_last_part"
        echo "New version: $new_version"
        mvn versions:set -DnewVersion=$new_version
        echo "new_version=$new_version" >> $GITHUB_ENV

    - name: Commit new version
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git checkout -b version-increment
        git add pom.xml
        git commit -m "Increment version to ${{ env.new_version }}"
        git push origin version-increment

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: version-increment
        title: "Increment version to ${{ env.new_version }}"
        body: "This PR increments the version number to ${{ env.new_version }}."
        base: main
        delete-branch: true

